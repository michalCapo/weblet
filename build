#!/bin/bash
# Build script for weblet with version as build date/time

set -e

# Check for required dependencies
check_dependencies() {
    echo "Checking dependencies..."
    
    # Check for Go
    if ! command -v go &> /dev/null; then
        echo "Error: Go is not installed"
        exit 1
    fi
    
    # Check for webkit2gtk (optional for webview)
    HAS_WEBKIT=false
    if pkg-config --exists webkit2gtk-4.0 2>/dev/null || pkg-config --exists webkit2gtk-4.1 2>/dev/null; then
        HAS_WEBKIT=true
        echo "✓ WebKit dependencies found (Native mode enabled)"
    else
        echo "⚠️  WebKit dependencies not found (Native mode will be disabled)"
        if [ -f /etc/fedora-release ]; then
            echo "   To enable native mode on Fedora, run: sudo dnf install webkit2gtk4.1-devel"
        elif [ -f /etc/debian_version ]; then
            echo "   To enable native mode on Debian/Ubuntu, run: sudo apt install libwebkit2gtk-4.0-dev"
        fi
    fi
    
    echo "✓ Build environment ready"
}

# Generate version: YYYYMMDD.HHMM format
generate_version() {
    VERSION=$(date +%Y%m%d.%H%M)
    echo "$VERSION"
}

# Build the binary
build() {
    VERSION=$(generate_version)
    
    echo "Building weblet version $VERSION..."
    
    BUILD_TAGS=""
    if [ "$HAS_WEBKIT" = false ]; then
        BUILD_TAGS="-tags no_native"
    fi

    # CGO is required for webview if we have webkit
    if [ "$HAS_WEBKIT" = true ]; then
        export CGO_ENABLED=1
    else
        export CGO_ENABLED=0
    fi
    
    set +e
    go build $BUILD_TAGS -ldflags "-X main.version=$VERSION" -o weblet .
    BUILD_EXIT_CODE=$?
    set -e
    
    if [ $BUILD_EXIT_CODE -ne 0 ]; then
        echo "Error: Build failed with exit code $BUILD_EXIT_CODE"
        exit $BUILD_EXIT_CODE
    fi
    
    echo "✓ Built weblet with version: $VERSION"
    if [ "$HAS_WEBKIT" = false ]; then
        echo "  Note: Built with 'no_native' tag (no native webview support)"
    fi
}

# Install to system PATH
install_system() {
    if [ ! -f weblet ]; then
        echo "Error: weblet binary not found. Run build first."
        exit 1
    fi
    
    echo "Installing weblet to /usr/bin/weblet..."
    sudo cp weblet /usr/bin/weblet
    echo "✓ Installed weblet to /usr/bin/weblet"
}

# Show usage
usage() {
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  build    - Build the weblet binary (default)"
    echo "  install  - Build and install to /usr/bin"
    echo "  check    - Check dependencies only"
    echo "  help     - Show this help"
}

# Main
case "${1:-build}" in
    build)
        check_dependencies
        build
        ;;
    install)
        check_dependencies
        build
        install_system
        ;;
    check)
        check_dependencies
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
